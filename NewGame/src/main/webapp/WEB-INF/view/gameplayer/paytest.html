<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>充值</title>
    <link rel="shortcut icon" href="${ctxPath}/static/style/images/favicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="${ctxPath}/static/layui/css/layui.css"/>
    <link rel="stylesheet" href="${ctxPath}/static/pay/css/payfor.css"/>
</head>
<body>
<div class="container">
    <!--充值类型按钮容器-->
    <div class="row1">
        <div>
            @if(wxtype == 1){
            <div class="pay-btn btn-warm" type="1">微信充值</div>
            @}else{
            <div class="not-btn">微信充值</div>
            @}
            @if(alipaytype == 1){
            <div class="pay-btn " type="2">支付宝充值</div>
            @}else{
            <div class="not-btn">支付宝充值</div>
            @}
            @if(Device_id == 0){
            <div class="pay-btn " type="3">VIP客服充值</div>
            @}else{
            <div class="not-btn">VIP客服充值</div>
            @}
        </div>
        <div class="call-btn"
             style="background-image:url('${ctxPath}/static/pay/image/dianwotoushu.png') !important;"></div>
    </div>
    <!--金额选择容器-->
    <div class="row2">
        <div class="layui-tab-content">
            <!--weixin支付-->
            @if(wxtype == 1){
            <div class="layui-tab-item layui-show pay-info">
                <div class="weixin-prompt"></div>
                <div class="number_amount">
                    <div class="show_doc">充值金额<input readonly="readonly" value="20" class="wx_money"  pid="1"/></div>
                    <div class="show_doc2">获得金币<input readonly="readonly" value="获得20万金币" class="wx_code"/></div>
                </div>
                <div class="number_chose">
                    <ul class="weixin_c">
                        <li>
                            <div class="but_num wx_num click_red" value="1">20</div>
                            <div>20万金币</div>
                        </li>
                        <li>
                            <div class="but_num wx_num" value="2">50</div>
                            <div>50万金币</div>
                        </li>
                        <li>
                            <div class="but_num wx_num" value="3">100</div>
                            <div>100万金币</div>
                        </li>
                        <li>
                            <div class="but_num wx_num" value="4">200</div>
                            <div>200万金币</div>
                        </li>
                        <li>
                            <div class="but_num wx_num" value="5">500</div>
                            <div>500万金币</div>
                        </li>
                        <li>
                            <div class="but_num wx_num" value="6">1000</div>
                            <div>1000万金币</div>
                        </li>
                        <li>
                            <div class="but_num wx_num" value="7">2000</div>
                            <div>2000万金币</div>
                        </li>
                        <li>
                            <div class="but_num wx_num" value="8">3000</div>
                            <div>3000万金币</div>
                        </li>
                    </ul>
                </div>
                <div class="paybutton" type="1"></div>
            </div>
            @}
            <!--alipay支付-->
            @if(alipaytype == 1 && wxtype == 1){
            <div class="layui-tab-item pay-info">
            @}else if(wxtype == 0){
            <div class="layui-tab-item layui-show pay-info">
            @}else{
            <div class="layui-tab-item pay-info" style="display: none">
            @}
                <div class="alipay-prompt"></div>
                <div class="number_amount">
                    <div class="show_doc">充值金额<input readonly="readonly" value="30" class="ali_money"  pid="1"/></div>
                    <div class="show_doc2">获得金币<input readonly="readonly" value="获得30万金币" class="ali_code"/></div>
                </div>
                <div class="number_chose">
                    <ul>
                        <li>
                            <div class="but_num pay_num click_red" value="1">30</div>
                            <div>30万金币</div>
                        </li>
                        <li>
                            <div class="but_num pay_num" value="2">50</div>
                            <div>50万金币</div>
                        </li>
                        <li>
                            <div class="but_num pay_num" value="3">100</div>
                            <div>100万金币</div>
                        </li>
                        <li>
                            <div class="but_num pay_num" value="4">200</div>
                            <div>200万金币</div>
                        </li>
                        <li>
                            <div class="but_num pay_num" value="5">500</div>
                            <div>500万金币</div>
                        </li>
                        <li>
                            <div class="but_num pay_num" value="6">1000</div>
                            <div>1000万金币</div>
                        </li>
                        <li>
                            <div class="but_num pay_num" value="7">2000</div>
                            <div>2000万金币</div>
                        </li>
                        <li>
                            <div class="but_num pay_num" value="8">3000</div>
                            <div>3000万金币</div>
                        </li>
                    </ul>
                </div>
                <div class="paybutton" type="2"></div>
            </div>
            <!--VIP客服充值-->
           <!-- <div class="layui-tab-item pay-info">内容3</div>-->
        </div>
    </div>
</div>
</div>

<script src="${ctxPath}/static/newskin/assets/js/jquery.min.js"></script>
<script src="${ctxPath}/static/layui/layui.all.js" type="text/javascript"></script>
<script>
    $(".pay-btn").click(function () {
        var show = $(this).attr("type");
       /* $(this).css({
            "background-image": "url('${ctxPath}/static/pay/image/dikuang1.png')",
            "color": "black"
        }).siblings().css({"background-image": "url('${ctxPath}/static/pay/image/dikuang2.png')", "color": "#fff"});*/
        $(".pay-btn:parent").css({"background-image": "url('${ctxPath}/static/pay/image/dikuang2.png')", "color": "#fff"});
        $(this).css({
            "background-image": "url('${ctxPath}/static/pay/image/dikuang1.png')",
            "color": "black"
        });
        $(".layui-tab-item").eq(show - 1).addClass("layui-show").siblings().removeClass("layui-show");
    })

    $(".wx_num").click(function () {
        $(".wx_num:parent").removeClass("click_red");
        $(this).addClass("click_red");
        $(".wx_money").val($(this).text());
        $(".wx_money").attr("pid",$(this).attr("value"));
        $(".wx_code").val("获得" + $(this).text() + "万金币");
    })
    $(".pay_num").click(function () {
        $(".pay_num:parent").removeClass("click_red");
        $(this).addClass("click_red");
        $(".ali_money").val($(this).text());
        $(".ali_money").attr("pid",$(this).attr("value"));
        $(".ali_code").val("获得" + $(this).text() + "万金币");
    })
    $(".paybutton").click(function () {
        console.log("支付类型"+$(this).attr("type"));
        var buyType = $(this).attr("type");
        var pid;
        if (buyType == 1) {
            pid = $(".wx_money").attr("pid");
            console.log("产品ID"+pid);
        } else {
            pid = $(".ali_money").attr("pid");
            console.log("产品ID"+pid);
        }
        layer.msg('正在请求支付接口', {
            shade: [0.8, '#393D49'],//遮罩
            time: 4000
        }, function () {
           // skipPay("https://www.baidu.com/");
            $.ajax({
                url: "${ctxPath}/webpay/genPayUrl",
                data: {
                    "Pid": pid,
                    "UserID": '${UserID!}',
                    "ClientType": '${ClientType!}',
                    "BuyType": buyType,
                    "Device_id": '${Device_id!}',
                    "Sign": '${Sign!}'
                },
                type: 'post',
                dataType: 'json',
                async: false,
                success: function (data) {
                    console.log(data);
                    if (data.code != 0) {
                        layer.msg(data.message);
                    } else {
                        //跳转二维码支付页面
                        var mess = data.message;
                        console.log(mess);

                        //优付弹出截取var url = mess.slice(mess.indexOf("http"),mess.lastIndexOf("\'")); var order_no = mess.slice(mess.lastIndexOf(":")+1);
                       //星辰支付订单号
                        var payurl = mess.substring(mess.indexOf("vvurl")+9,mess.indexOf("\";"))
                        var order_no = mess.substring(mess.indexOf("span")+5,mess.lastIndexOf("/span")-1);
                        skipPay(payurl,order_no);
                         //window.open(url);
                    }
                },
                error: function (state, type, err) {
                    console.log(type);
                    console.log(err);
                    console.log(state);
                }
            })
        });


        function skipPay(html,order) {
            var thirdReturn = layer.open({
                type:2,
                titile: false,
                area: ['450px', '400px'],
                closeBtn: 1,
                shade: [0.8, '#393D49'],
                shadeClose: false,
                skin: 'QrCode-class',
                content: [html, 'yes'],
                cancel: function(index, layero){
                    //if(confirm('确定要关闭么')){} //只有当点击confirm框的确定时，该层才会关闭
                    layer.msg("正在确认充值状态", {
                            shade: [0.8, '#393D49'],//遮罩
                            time: 1000
                        }, function () {
                        //layer.close(thirdReturn);
                        //setTimeout(changeState(), 1000);
                        $.ajax({
                            url:"${ctxPath}/webpay/checkstate",
                            data:{"order_no":order},
                            type:'post',
                            dataType: 'json',
                            async: false,
                            success:function (data) {
                                if(data.code != 0){
                                    layer.msg('充值未完成确定关闭吗?',{
                                        btn: ['是', '再等等'],
                                        yes:function (index) {
                                            layer.close(thirdReturn);
                                            console.log("关闭二维码页面");
                                            setTimeout(ErrorState(), 1000);
                                            layer.close(index);
                                        }
                                    })
                                }else{
                                    layer.close(thirdReturn);
                                    console.log("关闭二维码页面");
                                    setTimeout(SuccessState(), 1000);
                                }
                            }
                        })
                        }
                    );
                    return false;
                    //返回支付成功消息
                    function SuccessState() {
                        var payend = layer.open({
                            type: 1,
                            title: false,
                            area: ['659px', '407px'],
                            //offset: ['200px', '150px'],
                            closeBtn: 0,
                            shadeClose: true,
                            skin: 'return-class',
                            content: $('#tips_success')
                        });
                        $("#yes").click(function () {
                            layer.close(payend);
                            $("#tips_success").css("display", "none");
                        })
                    }
                    //返回支付失败消息
                    function ErrorState() {
                        var payend = layer.open({
                            type: 1,
                            title: false,
                            area: ['659px', '407px'],
                            //offset: ['200px', '150px'],
                            closeBtn: 0,
                            shadeClose: true,
                            skin: 'return-class',
                            content: $('#tips_error')
                        });
                        $("#no").click(function () {
                            layer.close(payend);
                            $("#tips_error").css("display", "none");
                        })
                    }
                }
            });
        }

    })
</script>
</body>
<div id="tips_success">
    <div id="yes"></div>
</div>
<div id="tips_error">
    <div id="no"></div>
</div>
</html>